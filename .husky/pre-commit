#!/bin/sh

FRONTEND_DIR="client"
BACKEND_DIR="server"

set -e

echo "========================================\n\tâš™ï¸ Running pre-commit checks\n========================================"

branch="$(git rev-parse --abbrev-ref HEAD)"
if [ "$branch" = "main" ]; then
  echo "âŒ You can't commit directly to main - please check out a branch."
  exit 1
fi

##############################
########## FRONTEND ##########
##############################

run_frontend_checks() {
    echo "âš™ï¸ Running frontend checks"
    cd "$FRONTEND_DIR" || exit 1

    # Linting
    echo "ğŸ” Frontend - Lint"
    npx lint-staged || {
        echo "âŒ Frontend - Lint failed"
        exit 1
    }

    # Building
    echo "ğŸ§± Frontend - Build"
    npm run build || {
        echo "âŒ Frontend - Build failed"
        exit 1
    }

    cd ..
}

#############################
########## BACKEND ##########
#############################

run_backend_checks() {
    echo "âš™ï¸ Running backend checks"
    cd "$BACKEND_DIR" || exit 1

    # Building
    echo "ğŸ§± Backend - Build"
    dotnet build --nologo || {
        echo "âŒ Backend - Build failed"
        exit 1
    }

    # Linting
    echo "ğŸ” Backend - Lint"
    dotnet format
    dotnet format --verify-no-changes --verbosity quiet || {
        echo "âŒ Backend - Lint failed"
        exit 1
    }

    # Testing
    echo "ğŸ§ª Backend - Test"
    dotnet test || {
        echo "âŒ Backend - Test failed"
        exit 1
    }

    cd ..
}

staged_files=$(git diff --cached --name-only --diff-filter=ACM)
printf "ğŸ“„ Staged files:\n$staged_files\n"

if echo "$staged_files" | grep -q "^$FRONTEND_DIR/"; then
    run_frontend_checks
fi

if echo "$staged_files" | grep -q "^$BACKEND_DIR/"; then
    run_backend_checks
fi


echo "âœ… All pre-commit checks passed!"
