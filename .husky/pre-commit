#!/bin/sh

set -e

branch="$(git rev-parse --abbrev-ref HEAD)"

if [ "$branch" = "main" ]; then
  echo "âŒ You can't commit directly to main - please check out a branch."
  exit 1
fi

##############################
########## FRONTEND ##########
##############################

FRONTEND_DIR="client"
cd "$FRONTEND_DIR" || exit 1

# Linting
echo "ğŸ” Frontend - Lint"
npx lint-staged || {
    echo "âŒ Frontend - Lint failed"
    exit 1
}

# Building
echo "ğŸ§± Frontend - Build"
npm run build || {
    echo "âŒ Frontend - Build failed"
    exit 1
}

cd ..

#############################
########## BACKEND ##########
#############################

BACKEND_DIR="server"
cd "$BACKEND_DIR" || exit 1

# Building
echo "ğŸ§± Backend - Build"
dotnet build --nologo || {
    echo "âŒ Backend - Build failed"
    exit 1
}

# Linting
echo "ğŸ” Backend - Lint"
dotnet format
dotnet format --verify-no-changes --verbosity quiet || {
    echo "âŒ Backend - Lint failed"
    exit 1
}

# Testing
echo "ğŸ§ª Backend - Test"
dotnet test || {
    echo "âŒ Backend - Test failed"
    exit 1
}

cd ..

echo "âœ… All pre-commit checks passed!"
